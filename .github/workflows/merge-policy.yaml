name: Merge Policy

on:
  pull_request:
    branches:
      - main
      - dev
    types: [opened, synchronize, reopened, edited]

jobs:
  enforce-merge-policy:
    name: Enforce Merge Policy
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04]
    
    steps:

      - name: Display Execution Context
        run: |
          echo "::group::Execution Context"
          echo "GitHub Ref: ${{ github.ref }}"
          echo "GitHub Event: ${{ github.event_name }}"
          echo "Pull Request Source Branch: ${{ github.head_ref }}"
          echo "Pull Request Target Branch: ${{ github.base_ref }}"
          echo "::endgroup::"


      - name: Reject Invalid Source Branch
        if: github.base_ref == 'main' && github.head_ref != 'dev'
        run: |
          echo "::error::Pull requests to 'main' must originate from 'dev' branch"
          echo "::error::Current source: ${{ github.head_ref }} → Target: ${{ github.base_ref }}"
          echo "::error::Please merge to 'dev' first, then create PR from 'dev' to 'main'"
          exit 1

      - name: Confirm Valid Source Branch
        if: github.base_ref == 'main' && github.head_ref == 'dev'
        run: |
          echo "::notice:: Merge policy validated successfully"
          echo "Source: ${{ github.head_ref }} → Target: ${{ github.base_ref }}"

      - name: Allow Dev Merge
        if: github.base_ref == 'dev'
        run: echo "::notice:: PR targets 'dev', merge policy check skipped."
