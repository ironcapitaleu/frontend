name: CI

on:
  pull_request:
    branches:
      - main
      - dev

permissions:
  contents: read
  id-token: write

env:
  # Set environment based on branch
  # If it's main branch, use 'production', else 'development'
  DEPLOYMENT_ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

jobs:
  ci:
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04]

    steps:
    - uses: actions/checkout@v5

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Display Execution Context
      run: |
        echo "::group::Execution Context"
        echo "Environment: ${{ env.DEPLOYMENT_ENVIRONMENT }}"
        echo "GitHub Ref: ${{ github.ref }}"
        echo "GitHub Event: ${{ github.event_name }}"
        echo "Node.js version: $(node --version)"
        echo "npm version: $(npm --version)"
        echo "npx version: $(npx --version)"
        echo "TypeScript version: $(npx tsc --version)"
        echo "biome version: $(npx biome --version)"
        echo "::endgroup::"

    - name: Code Formatting Check
      run: npm run format:check
    
    - name: Security Check
      run: npm run security:check

    - name: Linting
      run: npm run lint:check

    - name: Type Checking
      run: npm run typing:check
    
    - name: Build Check
      run: npm run build

    - name: Unit Tests
      run: npm run test:ci
