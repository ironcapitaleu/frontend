name: CD

on:
  push:
    branches:
      - main
      - master
    # Trigger on version tags for production deployments
    tags:
      - 'v*.*.*'  # Matches tags like v1.0.0, v2.1.3, etc.

permissions:
  contents: read
  packages: write  # For pushing to GitHub Container Registry (GHCR)

jobs:
  cd:
    # Set environment based on whether the ref is a tag or a branch
    # If it's a tag starting with 'v', use 'production', else 'development'
    environment:  ${{ startsWith(github.ref, 'refs/tags/v') && 'production' || 'development' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04]

    steps:
    - uses: actions/checkout@v5

    - name: Display Deployment Context
      run: |
        echo "::group::Deployment Context"
        echo "Deploying to environment: ${{ startsWith(github.ref, 'refs/tags/v') && 'production' || 'development' }}"
        echo "GitHub Ref: ${{ github.ref }}"
        echo "GitHub Event: ${{ github.event_name }}"
        echo "AWS Region: ${{ env.AWS_REGION }}"
        echo "AWS ACCOUNT ID: ${{ env.AWS_ACCOUNT_ID }}"
        echo "Deployment Role: ${{ env.DEPLOYMENT_ROLE }}"
        echo "::endgroup::"

